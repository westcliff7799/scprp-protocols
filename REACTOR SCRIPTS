-- source code by @friendo3
-- events by @west

-- options:
-- !reactor normal (INCOMPLETE)
-- !reactor tense (COMPLETE)
-- !reactor unstable (COMPLETE)
-- !reactor meltdown (INCOMPLETE)

-- !reactor safeguard (INCOMPLETE)
-- !reactor safeguardfailure (INCOMPLETE)

-- !reactor startup (INCOMPLETE)
-- !reactor startupfailure (INCOMPLETE)

-- !reactor shutdown (INCOMPLETE)
-- !reactor shutdownfailure (INCOMPLETE)

-- !reactor powerdischarge (COMPLETE)
-- !reactor stall (INCOMPLETE)
-- !reactor emergencycoolant (INCOMPLETE)
-- !reactor blackhole (INCOMPLETE)

local reactorCommand = "!reactor"
local authorized = {"westcliff7799", "Site4o4SSUH"}

local function startswith(str, prefix)
	return string.sub(str:lower(), 1, #prefix) == prefix:lower()
end

event("chatted", function(Data)
	local player = Data.Value[1]
	local msg = Data.Value[2]

	if startswith(msg, reactorCommand) then
		if not table.find(authorized, player) then
			runCommand("alert " .. player .. " You are not authorized to use this command.")
			return
		end

		local argument = string.sub(msg, #reactorCommand + 2)
		argument = argument:gsub("^%s*(.-)%s*$", "%1")

		if argument == "" then
			runCommand("alert " .. player .. " Please specify an event.")
			return
		end
		local argLower = argument:lower()


-- reactor status:
		if argLower == "normal" then
			runCommand("alert %class "..player.." has triggered a reactor event: "..argument)

		elseif argLower == "tense" then
			runCommand("alert %class "..player.." has triggered a reactor event: "..argument)
			runCommand("playsong 92444688295680 loop ")
			runCommand("modannounce [!]〔ASAS:〕”Danger. The reactor core has reached 3,500 kelvin. The option to engage the reactor meltdown safeguard is now available. Please activate cooling systems immediately” ")
			wait(30)
			runCommand("stopsong ")

		elseif argLower == "unstable" then
			runCommand("alert %class "..player.." has triggered a reactor event: "..argument)
			runCommand("alert all [EVENT] The following events after this message will have flashing lights. If you are affected by this please either leave the game or redirect eye contact. Thank you. ")
			runCommand("playsong 92444688295680 loop ")
			runCommand("modannounce [!]〔ASAS:〕”Danger. The reactor core has reached 4,500 kelvin. The option to activate the safeguard is now deemed non-functional and expired. Please activate cooling systems immediately” ")
			wait(1)
				local powerSurge = true
				local function lightFlicker()
					repeat
						runCommand("rlight ")
						runCommand("light 30 30 30 ")
						runCommand("lightoff 1 ")
						runCommand("rlight ")
						runCommand("light 30 30 30 ")
						runCommand("lightoff 1 ")
						runCommand("lightoff 1 ")
						task.wait(0.01)
					until powerSurge == false
				end
				task.spawn(lightFlicker)
				task.wait(30)
					powerSurge = false
			wait(1)
			resetLights()
			runCommand("stopsong ")

		elseif argLower == "meltdown" then
			runCommand("alert %class "..player.." has triggered a reactor event: "..argument)
			runCommand("alert all [EVENT] The following events after this message will have flashing lights. If you are affected by this please either leave the game or redirect eye contact. Thank you. ")
			runCommand("playsong 6680429831 loop ")
			runCommand("modannounce [!]〔ASAS:〕”Attention. Reactor core meltdown detected. An automatic code white directive has been issued. All non-essential staff evacuate to the emergency bunker or evacuate the facilty” ")
			wait(1)
				local powerSurge = true
				local function lightFlicker()
					repeat
						runCommand("rlight ")
						runCommand("light 100 30 10 ")
						runCommand("lightoff 2 ")
						runCommand("rlight ")
						runCommand("light 100 30 10 ")
						runCommand("lightoff 2 ")
						runCommand("lightoff 3 ")
						task.wait(0.01)
					until powerSurge == false
				end
				task.spawn(lightFlicker)
				task.wait(30)
					powerSurge = false

				resetLights()
			wait(0.5)
				colorLights(100, 30, 10)


-- safeguard events:
		elseif argLower == "safeguard" then
			runCommand("alert %class "..player.." has triggered a reactor event: "..argument)


-- other events:
		elseif argLower == "powerdischarge" then
			runCommand("alert %class "..player.." has triggered a reactor event: "..argument)
			runCommand("playsong 1846999567 ")
			runCommand("playsound all 75252663376211 ")
			wait(1)
				local powerSurge = true
				local function lightFlicker()
					repeat
						runCommand("rlight ")
						runCommand("light 30 30 30 ")
						runCommand("lightoff 1 ")
						runCommand("rlight ")
						runCommand("light 30 30 30 ")
						runCommand("lightoff 1 ")
						runCommand("lightoff 1 ")
						task.wait(0.01)
					until powerSurge == false
				end
				task.spawn(lightFlicker)
				task.wait(30)
					powerSurge = false

				resetLights()
			wait(0.5)
				colorLights(100, 30, 10)
			wait(0.5)
				disableLights(1.5)
				runCommand("playsound all 92444688295680 loop ")
			wait (9)
				runCommand("playsong 82198078552995 ")
			wait(13)
				runCommand("stopsounds all ")
				runCommand("playsong 1846999567 ")


-- unknown event
		else
			runCommand("alert "..player.." Unknown event "..argument)
		end
	end
end)
